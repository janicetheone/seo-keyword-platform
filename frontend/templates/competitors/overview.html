{% extends "base.html" %}
{% block title %}Competitors - SEO Keyword Platform{% endblock %}
{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900">Competitor Analysis</h2>
    <p class="text-sm text-gray-500 mt-1">Monitor and analyze competitor keyword strategies</p>
</div>

<!-- Add Competitor -->
<div class="bg-white rounded-xl p-6 shadow-sm mb-8">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">Add Competitor</h3>
    <form id="add-competitor-form" class="flex gap-4">
        <input type="text" id="comp-domain" placeholder="domain.com" required
            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
        <input type="text" id="comp-name" placeholder="Display Name" required
            class="w-48 px-3 py-2 border border-gray-300 rounded-lg text-sm">
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">Add</button>
    </form>
</div>

<!-- Competitors Table -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <table class="kw-table">
        <thead>
            <tr>
                <th>Competitor</th>
                <th>Domain</th>
                <th>Pages Crawled</th>
                <th>Last Crawled</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="competitors-body">
            <tr><td colspan="5" class="text-center py-8 text-gray-400">Loading...</td></tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadCompetitors() {
    const resp = await fetch('/api/competitors');
    const data = await resp.json();
    const tbody = document.getElementById('competitors-body');

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">No competitors added yet.</td></tr>';
        return;
    }

    tbody.innerHTML = data.map(c => `
        <tr>
            <td><a href="/competitors/${c.id}" class="text-indigo-600 hover:underline font-medium">${c.name}</a></td>
            <td class="text-gray-500">${c.domain}</td>
            <td>${c.total_pages}</td>
            <td class="text-sm text-gray-500">${c.last_crawled ? new Date(c.last_crawled).toLocaleDateString() : 'Never'}</td>
            <td class="flex gap-2">
                <button onclick="analyzeCompetitor(${c.id})" class="px-3 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">Analyze</button>
                <button onclick="deleteCompetitor(${c.id})" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">Delete</button>
            </td>
        </tr>
    `).join('');
}

async function analyzeCompetitor(id) {
    const resp = await fetch(`/api/competitors/${id}/analyze`, { method: 'POST' });
    const data = await resp.json();
    alert(`Analysis started for ${data.competitor}. Check Jobs page for progress.`);
}

async function deleteCompetitor(id) {
    if (!confirm('Delete this competitor?')) return;
    await fetch(`/api/competitors/${id}`, { method: 'DELETE' });
    loadCompetitors();
}

document.getElementById('add-competitor-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const domain = document.getElementById('comp-domain').value.trim();
    const name = document.getElementById('comp-name').value.trim();
    await fetch('/api/competitors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain, name }),
    });
    document.getElementById('comp-domain').value = '';
    document.getElementById('comp-name').value = '';
    loadCompetitors();
});

loadCompetitors();
</script>
{% endblock %}
